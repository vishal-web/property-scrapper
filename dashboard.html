<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Property Scraper Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
      <!-- Header -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold text-gray-800">
              üè† Property Scraper Dashboard
            </h1>
            <p class="text-gray-600 mt-1">
              MagicBricks Property Data Extractor
            </p>
          </div>
          <button
            onclick="exportToCSV()"
            id="exportBtn"
            disabled
            class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition"
          >
            üì• Export CSV
          </button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-gray-600 text-sm">Total Properties</p>
          <p class="text-3xl font-bold text-indigo-600" id="totalCount">0</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-gray-600 text-sm">Successful</p>
          <p class="text-3xl font-bold text-green-600" id="successCount">0</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-gray-600 text-sm">Failed</p>
          <p class="text-3xl font-bold text-red-600" id="failedCount">0</p>
        </div>
      </div>

      <!-- Scraper Controls -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Run Scraper</h2>
        <div class="flex gap-4">
          <input
            type="text"
            id="urlInput"
            value="https://www.magicbricks.com/flats-for-rent-in-bangalore-pppfr"
            placeholder="Enter MagicBricks URL"
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
          <button
            onclick="runScraper()"
            id="scrapeBtn"
            class="flex items-center gap-2 px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 transition"
          >
            ‚ñ∂Ô∏è Start Scrape
          </button>
        </div>
      </div>

      <!-- Logs -->
      <div
        class="bg-white rounded-lg shadow-lg p-6 mb-6"
        id="logsContainer"
        style="display: none"
      >
        <h2 class="text-xl font-bold text-gray-800 mb-4">Logs</h2>
        <div
          class="bg-gray-900 rounded-lg p-4 h-48 overflow-y-auto font-mono text-sm"
          id="logsContent"
        ></div>
      </div>

      <!-- Properties Table -->
      <div
        class="bg-white rounded-lg shadow-lg p-6"
        id="tableContainer"
        style="display: none"
      >
        <h2 class="text-xl font-bold text-gray-800 mb-4">
          Scraped Properties (<span id="propertyCount">0</span>)
        </h2>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="bg-gray-100 border-b">
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-gray-700"
                >
                  Title
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-gray-700"
                >
                  Location
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-gray-700"
                >
                  Price
                </th>
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-gray-700"
                >
                  Details
                </th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Empty State -->
      <div
        class="bg-white rounded-lg shadow-lg p-12 text-center"
        id="emptyState"
      >
        <div class="text-6xl mb-4">üè†</div>
        <p class="text-gray-500 text-lg">
          No properties scraped yet. Click "Start Scrape" to begin.
        </p>
      </div>
    </div>

    <script>
      let properties = [];
      let isRunning = false;
      let eventSource = null;

      const apiUrl = apiUrl;

      function addLog(message, type = "info") {
        const logsContainer = document.getElementById("logsContainer");
        const logsContent = document.getElementById("logsContent");
        logsContainer.style.display = "block";

        const timestamp = new Date().toLocaleTimeString();
        const colors = {
          info: "text-gray-300",
          success: "text-green-400",
          error: "text-red-400",
          warning: "text-yellow-400",
        };

        const logEntry = document.createElement("div");
        logEntry.className = `mb-1 ${colors[type] || colors.info}`;
        logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
        logsContent.appendChild(logEntry);
        logsContent.scrollTop = logsContent.scrollHeight;
      }

      function updateStats(total, newCount, updatedCount) {
        document.getElementById("totalCount").textContent = total;
        document.getElementById("successCount").textContent = newCount;
        document.getElementById("failedCount").textContent = updatedCount;
      }

      function renderProperties(data, append = false) {
        const tableBody = document.getElementById("tableBody");
        const tableContainer = document.getElementById("tableContainer");
        const emptyState = document.getElementById("emptyState");
        const propertyCount = document.getElementById("propertyCount");
        const exportBtn = document.getElementById("exportBtn");

        if (!append) {
          tableBody.innerHTML = "";
        }

        if (data.length === 0 && !append) {
          tableContainer.style.display = "none";
          emptyState.style.display = "block";
          exportBtn.disabled = true;
          return;
        }

        tableContainer.style.display = "block";
        emptyState.style.display = "none";
        exportBtn.disabled = false;
        propertyCount.textContent = properties.length;

        const propertiesToRender = append ? data : data;

        propertiesToRender.forEach((property) => {
          const row = document.createElement("tr");
          row.className = "border-b hover:bg-gray-50 transition";

          // Add visual indicator for new vs updated
          const indicator = property.isNew
            ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">NEW</span>'
            : '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">UPDATED</span>';

          row.innerHTML = `
            <td class="px-4 py-3 text-sm text-gray-800">
              ${property.title || property.name || "N/A"}
              ${property.isNew !== undefined ? indicator : ""}
            </td>
            <td class="px-4 py-3 text-sm text-gray-600">üìç ${
              property.location || property.area || "N/A"
            }</td>
            <td class="px-4 py-3 text-sm font-semibold text-green-600">${
              property.price || property.rent || "N/A"
            }</td>
            <td class="px-4 py-3 text-sm text-gray-600">${
              property.bedrooms || property.bhk || "N/A"
            } | ${property.area || property.sqft || "N/A"}</td>
          `;

          // Add animation for new rows
          row.style.animation = "fadeIn 0.3s ease-in";
          tableBody.appendChild(row);
        });
      }

      async function runScraper() {
        if (isRunning) return;

        const urlInput = document.getElementById("urlInput");
        const scrapeBtn = document.getElementById("scrapeBtn");
        const url = urlInput.value.trim();

        if (!url) {
          alert("Please enter a URL");
          return;
        }

        isRunning = true;
        scrapeBtn.disabled = true;
        scrapeBtn.innerHTML = "‚è≥ Running...";

        // Clear previous data and logs
        properties = [];
        document.getElementById("logsContent").innerHTML = "";
        document.getElementById("tableBody").innerHTML = "";
        updateStats(0, 0, 0);

        // Close previous EventSource if exists
        if (eventSource) {
          eventSource.close();
        }

        addLog("üöÄ Starting scraper...", "info");

        try {
          // Start scraping session
          const response = await fetch(`${apiUrl}/scrape`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const { sessionId, status, logsUrl } = await response.json();
          addLog(`üì° Session started: ${sessionId}`, "success");

          // Connect to SSE for real-time streaming
          eventSource = new EventSource(logsUrl);

          let newCount = 0;
          let updatedCount = 0;

          eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);

            switch (data.type) {
              case "connected":
                addLog("‚úÖ Connected to stream", "success");
                break;

              case "log":
                addLog(data.message, "info");
                break;

              case "info":
                addLog(data.message, "info");
                break;

              case "checkpoint":
                // Render batch of properties from this page
                if (data.properties && data.properties.length > 0) {
                  properties.push(...data.properties);
                  renderProperties(data.properties, true);

                  // Update counters based on the properties
                  data.properties.forEach((prop) => {
                    if (prop.isNew) {
                      newCount++;
                    } else {
                      updatedCount++;
                    }
                  });

                  updateStats(properties.length, newCount, updatedCount);
                }

                addLog(
                  `üíæ Checkpoint: Page ${data.page} complete - ${data.pageProperties} properties found`,
                  "success",
                );
                addLog(
                  `üìä Stats - Total: ${data.totalScraped}, New: ${data.stats.new}, Updated: ${data.stats.updated}`,
                  "info",
                );
                break;

              case "resume":
                addLog(
                  `üìä Resuming from page ${data.fromPage} - Previous total: ${data.previousTotal}`,
                  "warning",
                );
                break;

              case "progress":
                addLog(
                  `‚è≥ ${data.message}${data.percentage ? ` (${data.percentage}%)` : ""}`,
                  "info",
                );
                break;

              case "partial_data":
                // Handle any additional partial data updates
                if (data.data) {
                  addLog(`üì¶ Received data chunk`, "info");
                }
                break;

              case "success":
                addLog(data.message, "success");
                if (data.summary) {
                  addLog(
                    `üìà Final Summary - Total: ${data.summary.totalScraped}, New: ${data.summary.newProperties}, Updated: ${data.summary.updatedProperties}, Pages: ${data.summary.lastPage}`,
                    "success",
                  );
                }
                break;

              case "error":
                addLog(`‚ùå ${data.message}`, "error");
                break;

              case "completed":
                addLog("‚úÖ Scraping completed successfully!", "success");
                eventSource.close();
                isRunning = false;
                scrapeBtn.disabled = false;
                scrapeBtn.innerHTML = "‚ñ∂Ô∏è Start Scrape";
                break;

              case "failed":
                addLog(`‚ùå Scraping failed: ${data.message}`, "error");
                eventSource.close();
                isRunning = false;
                scrapeBtn.disabled = false;
                scrapeBtn.innerHTML = "‚ñ∂Ô∏è Start Scrape";
                break;

              default:
                console.log("Unknown event type:", data.type, data);
            }
          };

          eventSource.onerror = (error) => {
            addLog("‚ö†Ô∏è Connection lost or ended", "error");
            eventSource.close();
            isRunning = false;
            scrapeBtn.disabled = false;
            scrapeBtn.innerHTML = "‚ñ∂Ô∏è Start Scrape";
          };
        } catch (error) {
          addLog(`‚ùå Error: ${error.message}`, "error");
          addLog(
            `üí° Make sure your API server is running on ${apiUrl}`,
            "info",
          );
          isRunning = false;
          scrapeBtn.disabled = false;
          scrapeBtn.innerHTML = "‚ñ∂Ô∏è Start Scrape";
        }
      }

      function stopScraper() {
        if (eventSource) {
          eventSource.close();
          addLog("‚èπÔ∏è Scraper stopped by user", "warning");
        }
        isRunning = false;
        const scrapeBtn = document.getElementById("scrapeBtn");
        scrapeBtn.disabled = false;
        scrapeBtn.innerHTML = "‚ñ∂Ô∏è Start Scrape";
      }

      function exportToCSV() {
        if (properties.length === 0) {
          alert("No properties to export");
          return;
        }

        const headers = Object.keys(properties[0]).join(",");
        const rows = properties.map((p) =>
          Object.values(p)
            .map((v) => `"${String(v).replace(/"/g, '""')}"`)
            .join(","),
        );
        const csv = [headers, ...rows].join("\n");

        const blob = new Blob([csv], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `properties_${Date.now()}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);

        addLog(`üì• Exported ${properties.length} properties to CSV`, "success");
      }

      // Add CSS animation
      const style = document.createElement("style");
      style.textContent = `
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-10px); }
          to { opacity: 1; transform: translateY(0); }
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
